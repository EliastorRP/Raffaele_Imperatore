<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOC-01 — JOURNAL POST-COMA</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="site-header">
  <div class="logo-zone">
    <div class="logo-symbol">Σ</div>
    <span class="logo-text">Scientifique de Genesis</span>
  </div>

  <nav class="main-nav">
    <ul>
      <li><a href="index.html">Accueil</a></li>
      <li><a href="identite.html">Identité</a></li>
      <li><a href="physique.html">Description Physique</a></li>
      <li><a href="caractere.html">Caractère</a></li>
      <li><a href="informations.html" class="active">Documents</a></li>
      <li><a href="histoire.html">Histoire</a></li>
      <li><a href="funfacts.html">Fun Facts</a></li>
    </ul>
  </nav>
</header>

<!-- LOCK OVERLAY -->
<div class="doc-lock" id="docLock">
  <div class="doc-lock-box">
    <p class="doc-lock-kicker">ACCÈS CLASSIFIÉ</p>
    <h1 class="doc-lock-title">DOCUMENT VERROUILLÉ</h1>
    <p class="doc-lock-text">
      Fragmentation neuro-mnémique détectée. Stabilisation requise.
    </p>

    <form class="doc-lock-form" id="docLockForm">
      <label class="doc-lock-label">
        MOT DE PASSE
        <input type="password" class="doc-lock-input" id="docLockInput" autocomplete="off" />
      </label>

      <div class="doc-lock-actions">
        <a class="doc-lock-back" href="informations.html">Retour</a>
        <button class="doc-lock-btn" type="submit">Déverrouiller</button>
      </div>

      <p class="doc-lock-error" id="docLockError" aria-live="polite"></p>
    </form>
  </div>
</div>

<main class="content">
  <div id="docContent" aria-hidden="true">

    <section class="panel coma-panel">
      <header class="coma-head">
        <h1 class="coma-title">JOURNAL POST-COMA</h1>
        <p class="coma-subtitle">
          Transcription reconstituée. Lecture instable.  
          Les fragments se dégradent en dehors de l’attention du lecteur.
        </p>
      </header>

      <div class="coma-layout">

        <!-- LISTE ANNEES -->
        <aside class="coma-index" aria-label="Index des fragments">
          <div class="coma-index-top">
            <span class="coma-chip">DOC-01</span>
            <span class="coma-chip coma-chip--warn">INSTABLE</span>
          </div>

          <div class="coma-years" id="comaYears"></div>

          <div class="coma-index-actions">
            <button class="coma-btn" id="prevYear" type="button">⟵ Fragment précédent</button>
            <button class="coma-btn coma-btn--primary" id="nextYear" type="button">Fragment suivant ⟶</button>
          </div>

          <p class="coma-hint">
            Astuce : utilise <span class="highlight">Stabiliser</span> pour rendre le texte lisible quelques secondes.
          </p>
        </aside>

        <!-- LECTURE -->
        <section class="coma-reader" aria-label="Lecture du fragment">
          <div class="coma-reader-top">
            <div class="coma-reader-left">
              <div class="coma-frag-label">FRAGMENT</div>
              <div class="coma-frag-title" id="fragTitle">Année 1</div>
            </div>

            <div class="coma-reader-right">
              <button class="coma-btn coma-btn--ghost" id="stabilizeBtn" type="button">
                Stabiliser
              </button>
              <div class="coma-meter">
                <div class="coma-meter-fill" id="stabilityFill"></div>
              </div>
            </div>
          </div>

          <div class="coma-paper" id="comaPaper">
            <!-- texte injecté -->
          </div>

          <div class="coma-footer">
            <span class="coma-footer-left">GENESIS // Mémoire assistée</span>
            <span class="coma-footer-right" id="fragMeta">INTÉGRITÉ : 31%</span>
          </div>
        </section>

      </div>
    </section>

  </div>
</main>

<script>
/* ========= SHA-256 ========= */
async function sha256Hex(str) {
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const buf = await crypto.subtle.digest("SHA-256", data);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2, "0")).join("");
}

const DOC_PASSWORD_HASH = "ebc5a55921a9f97a75b75bfbda7dbb34d3693551e0f830633c705369964e1674";

/* ========= LOCK ========= */
const lock   = document.getElementById("docLock");
const form   = document.getElementById("docLockForm");
const input  = document.getElementById("docLockInput");
const error  = document.getElementById("docLockError");
const docContent = document.getElementById("docContent");

function setLockedState(isLocked) {
  if (!lock || !docContent) return;

  if (isLocked) {
    lock.style.display = "";                 // important: le remettre si bfcache
    lock.classList.remove("is-unlocked");
    docContent.setAttribute("aria-hidden", "true");
    if (input) input.value = "";
    if (error) error.textContent = "";
    // focus propre
    setTimeout(() => input?.focus(), 0);
  } else {
    lock.classList.add("is-unlocked");
    docContent.setAttribute("aria-hidden", "false");
    // on laisse l’anim puis on cache
    setTimeout(() => { lock.style.display = "none"; }, 180);
  }
}

/* Toujours verrouiller à l'arrivée + quand on revient via le bouton "retour" */
window.addEventListener("pageshow", () => {
  setLockedState(true);
});

/* Submit du mot de passe */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Normalisation = évite les caractères invisibles / variantes unicode
  const value = (input.value || "").normalize("NFKC").trim();

  if (!value) return;

  try {
    const h = await sha256Hex(value);

    if (h === DOC_PASSWORD_HASH) {
      setLockedState(false);
    } else {
      error.textContent = "Mot de passe incorrect.";
      input.select();
    }
  } catch (err) {
    console.error(err);
    error.textContent = "Erreur technique.";
  }
});

/* ========= CONTENU JOURNAL ========= */
const FRAGS = [
  { year: 1, integrity: 34, lines: [
    "On les appelle les “doués”.",
    "",
    "Je n’aime pas ce mot.",
    "Il suppose un mérite.",
    "",
    "Ils ne l’ont pas mérité.",
    "",
    "Certains déplacent des objets sans les toucher.",
    "D’autres referment des plaies sous les applaudissements.",
    "",
    "On parle d’évolution.",
    "",
    "Je me demande qui a décidé que c’en était une."
  ]},
  { year: 2, integrity: 28, lines: [
    "Un immeuble s’est effondré aujourd’hui.",
    "",
    "Pas une bombe.",
    "Pas un missile.",
    "",
    "Un homme.",
    "",
    "Il a perdu le contrôle.",
    "Le béton s’est tordu comme de l’argile.",
    "Les étages se sont écrasés les uns sur les autres.",
    "",
    "On a sorti des corps en morceaux.",
    "Des torses sans jambes.",
    "Des mains seules sous les gravats.",
    "",
    "On l’a appelé accident.",
    "",
    "Deux cent trente morts."
  ]},
  { year: 3, integrity: 31, lines: [
    "Ils disent qu’ils veulent aider.",
    "",
    "Mais le monde ne se plie plus aux règles.",
    "Il se plie à eux.",
    "",
    "Une femme a comprimé l’air autour d’un voleur.",
    "Ses poumons ont éclaté à l’intérieur de sa cage thoracique.",
    "Il est tombé en suffoquant son propre sang.",
    "",
    "Elle pleurait.",
    "On l’a consolée.",
    "",
    "Pas lui."
  ]},
  { year: 4, integrity: 22, lines: [
    "Les camps ont ouvert.",
    "",
    "On attache les “doués” pour les tester.",
    "On les découpe parfois.",
    "",
    "J’ai vu une salle blanche repeinte en rouge.",
    "",
    "Ils veulent comprendre comment ça fonctionne.",
    "Où ça commence dans le corps.",
    "",
    "Ils ouvrent les thorax pendant que le cœur bat encore.",
    "",
    "Ils appellent ça science."
  ]},
  { year: 5, integrity: 26, lines: [
    "Les “doués” ont commencé à riposter.",
    "",
    "Un homme a fissuré le sol sous une place publique.",
    "Des corps ont disparu dans l’ouverture.",
    "Certains sont restés coincés, broyés entre deux plaques de béton.",
    "",
    "Les cris ne s’arrêtent jamais tout de suite.",
    "C’est ça le pire.",
    "",
    "Ils durent."
  ]},
  { year: 6, integrity: 19, lines: [
    "Un enfant.",
    "",
    "Il ne devait pas avoir plus de neuf ans.",
    "",
    "Il a levé la main.",
    "Quelqu’un l’avait frappé.",
    "",
    "L’homme qui l’avait frappé a brûlé de l’intérieur.",
    "Sa peau est restée intacte quelques secondes…",
    "puis elle a éclaté.",
    "",
    "J’ai encore l’odeur dans la gorge.",
    "",
    "On ne devrait pas donner un tel pouvoir à un corps si petit."
  ]},
  { year: 7, integrity: 23, lines: [
    "Les villes ne tiennent plus.",
    "",
    "Des “doués” prennent le contrôle de quartiers entiers.",
    "Certains protègent.",
    "D’autres règnent.",
    "",
    "J’ai vu des exécutions publiques.",
    "",
    "Un homme suspendu dans les airs, lentement compressé.",
    "Ses os ont cédé un à un.",
    "On entend le craquement avant le cri.",
    "",
    "On a applaudi.",
    "",
    "La peur change les foules."
  ]},
  { year: 8, integrity: 21, lines: [
    "Il n’y a plus de lois.",
    "",
    "Seulement des dominants.",
    "",
    "Certains “doués” se disent sauveurs.",
    "Ils exigent loyauté en échange de protection.",
    "",
    "J’ai vu des corps marqués au fer.",
    "J’ai vu des langues arrachées pour avoir insulté l’un d’eux.",
    "",
    "Ils ne sont pas des monstres.",
    "",
    "C’est pire.",
    "",
    "Ils sont humains avec trop de pouvoir."
  ]},
  { year: 9, integrity: 18, lines: [
    "Le monde s’effondre.",
    "",
    "Les tempêtes rasent les côtes.",
    "Les fleuves débordent sans saison.",
    "",
    "Chaque catastrophe a un visage derrière elle.",
    "Toujours un.",
    "",
    "J’ai marché dans une rue couverte de cendres.",
    "Des silhouettes calcinées étaient encore assises contre les murs.",
    "",
    "On aurait dit qu’elles attendaient encore.",
    "",
    "Je ne pleure plus."
  ]},
  { year: 10, integrity: 16, lines: [
    "Il ne reste presque rien.",
    "",
    "Les “doués” meurent aussi.",
    "Ils saignent.",
    "Ils crient.",
    "",
    "Mais c’est à cause d’eux que tout a commencé.",
    "",
    "Le monde ne s’est pas détruit en un jour.",
    "Il s’est fissuré autour de leur existence.",
    "",
    "S’ils n’étaient jamais apparus,",
    "nous aurions continué à mourir lentement, normalement.",
    "",
    "Pas comme ça.",
    "",
    "Je les hais.",
    "",
    "Pas parce qu’ils sont différents.",
    "",
    "Parce qu’ils ont rendu la différence mortelle."
  ]}
];

/* ========= UI Journal ========= */
const yearsWrap = document.getElementById("comaYears");
const fragTitle = document.getElementById("fragTitle");
const comaPaper = document.getElementById("comaPaper");
const fragMeta  = document.getElementById("fragMeta");
const prevYear  = document.getElementById("prevYear");
const nextYear  = document.getElementById("nextYear");
const stabilizeBtn = document.getElementById("stabilizeBtn");
const stabilityFill = document.getElementById("stabilityFill");

let current = 0;
let stableMode = 0; // ticks de stabilisation

const GLITCH_CHARS = "█▓▒░<>/\\[]{}!@#$%&*+=-";
const TICK = 42;

function renderIndex() {
  yearsWrap.innerHTML = "";
  FRAGS.forEach((f, i) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "coma-year" + (i === current ? " is-active" : "");
    btn.innerHTML = `
      <span class="coma-year-left">Année ${f.year}</span>
      <span class="coma-year-right">${String(f.integrity).padStart(2,"0")}%</span>
    `;
    btn.addEventListener("click", () => {
      current = i;
      renderIndex();
      renderFrag(true);
    });
    yearsWrap.appendChild(btn);
  });
}

function baseTextLines() {
  return FRAGS[current].lines.slice();
}

function glitchLine(line, strength) {
  // strength: 0 = normal, 1 = très glitché
  if (!line) return "";
  const out = [];
  for (const ch of line) {
    if (ch === " " || ch === "’" || ch === "'" || ch === "“" || ch === "”" || ch === "…" ) {
      out.push(ch);
      continue;
    }
    if (Math.random() < strength) {
      out.push(GLITCH_CHARS[Math.floor(Math.random() * GLITCH_CHARS.length)]);
    } else {
      out.push(ch);
    }
  }
  return out.join("");
}

function renderFrag(forcePlain=false) {
  const frag = FRAGS[current];
  fragTitle.textContent = `Année ${frag.year}`;
  fragMeta.textContent  = `INTÉGRITÉ : ${frag.integrity}%`;

  // barre de stabilité (plus intégrité = plus stable)
  const baseStability = Math.min(0.9, Math.max(0.1, frag.integrity / 100));
  stabilityFill.style.width = Math.round(baseStability * 100) + "%";

  // texte (on le met en "lignes" pour un rendu journal)
  const lines = baseTextLines();
  comaPaper.innerHTML = lines.map(l => `<div class="coma-line">${l}</div>`).join("");

  if (forcePlain) return;
}

function updateNavButtons() {
  prevYear.disabled = current === 0;
  nextYear.disabled = current === FRAGS.length - 1;
  prevYear.style.opacity = prevYear.disabled ? .5 : 1;
  nextYear.style.opacity = nextYear.disabled ? .5 : 1;
}

prevYear.addEventListener("click", () => {
  if (current <= 0) return;
  current--;
  renderIndex();
  renderFrag(true);
  updateNavButtons();
});

nextYear.addEventListener("click", () => {
  if (current >= FRAGS.length - 1) return;
  current++;
  renderIndex();
  renderFrag(true);
  updateNavButtons();
});

stabilizeBtn.addEventListener("click", () => {
  // 2.5 secondes de stabilité
  stableMode = 480;
});


/* Tick corruption */
setInterval(() => {
  // si pas encore déverrouillé, ne rien faire
  if (docContent?.getAttribute("aria-hidden") === "true") return;

  const frag = FRAGS[current];

  // + faible intégrité = + glitch (comme avant)
  const baseStrength = 1 - Math.min(0.92, Math.max(0.15, frag.integrity / 100));
  const stabilized = stableMode > 0;

  // barre de stabilité
  const baseStability = Math.min(0.9, Math.max(0.1, frag.integrity / 100));
  const extra = stabilized ? 0.25 : 0;
  stabilityFill.style.width = Math.round(Math.min(1, baseStability + extra) * 100) + "%";

    const nodes = comaPaper.querySelectorAll(".coma-line");
  const src = FRAGS[current].lines;

  // ✅ SI stabilisé -> texte réel + jauge 100% + on sort
  if (stabilized) {
    stabilityFill.style.width = "100%";

    nodes.forEach((node, idx) => {
      node.textContent = src[idx] ?? "";
    });

    stableMode--; // on consomme la stabilisation
    return;
  }

  // glitch normal
  const strength = baseStrength * 0.95;

  nodes.forEach((node, idx) => {
    const line = src[idx] ?? "";
    node.textContent = line ? glitchLine(line, strength) : "";
  });


}, TICK);


/* init */
document.addEventListener("DOMContentLoaded", () => {
  renderIndex();
  renderFrag(true);
  updateNavButtons();
});
</script>

</body>
</html>
